<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ½çç¨‹å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 18px;
            margin: 20px 10px;
        }

        .participants-section {
            margin-bottom: 30px;
        }

        .participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            min-height: 60px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .participant-tag {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeInScale 0.3s ease;
        }

        .remove-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .lottery-section {
            margin-bottom: 30px;
        }

        .winner-display {
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            color: white;
            font-size: 2em;
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .winner-display.spinning {
            animation: pulse 0.5s infinite alternate;
        }

        .winner-display.winner-announced {
            animation: celebration 0.8s ease;
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
        }

        .winner-text {
            z-index: 2;
            position: relative;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ffd700);
            animation: confetti-fall 3s ease-out forwards;
            opacity: 0;
        }

        .winners-history {
            margin-top: 20px;
            text-align: left;
        }

        .winner-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            animation: slideInLeft 0.5s ease;
        }

        .empty-state {
            color: #6c757d;
            font-style: italic;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.02);
            }
        }

        @keyframes celebration {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100px) rotate(360deg);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            input[type="text"] {
                min-width: auto;
            }
            
            .btn-large {
                padding: 14px 24px;
                font-size: 16px;
                margin: 10px 5px;
            }
            
            .winner-display {
                font-size: 1.5em;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ æŠ½çç¨‹å¼</h1>
        
        <div class="input-section">
            <div class="input-group">
                <input type="text" id="participantInput" placeholder="è¼¸å…¥åƒåŠ è€…å§“å" maxlength="20">
                <button class="btn" onclick="addParticipant()">æ–°å¢</button>
            </div>
            <div class="input-group">
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVFile(this)">
                <button class="btn" onclick="document.getElementById('csvFileInput').click()">ğŸ“ åŒ¯å…¥CSV</button>
                <button class="btn btn-secondary" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
            </div>
            <div class="csv-info">
                <small style="color: #6c757d; display: block; margin-top: 10px;">
                    ğŸ’¡ <strong>CSVæ ¼å¼ç¯„ä¾‹ï¼š</strong><br>
                    â€¢ æœ‰æ¨™é¡Œï¼šå§“å,éƒ¨é–€,è·ä½<br>
                    â€¢ ç´”å§“åï¼šæ¯è¡Œä¸€å€‹å§“å<br>
                    â€¢ æ”¯æ´æ¬„ä½ï¼šå§“åã€åå­—ã€nameã€Name
                </small>
                <button class="btn" style="margin-top: 10px; font-size: 12px; padding: 6px 12px;" onclick="downloadSampleCSV()">ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹æª”æ¡ˆ</button>
            </div>
        </div>

        <div class="participants-section">
            <h3>åƒåŠ è€…åˆ—è¡¨ (<span id="participantCount">0</span>äºº)</h3>
            <div class="participants-list" id="participantsList">
                <div class="empty-state">å°šç„¡åƒåŠ è€…ï¼Œè«‹å…ˆæ–°å¢åƒåŠ è€…</div>
            </div>
        </div>

        <div class="lottery-section">
            <div class="winner-display" id="winnerDisplay">
                <div class="winner-text">æº–å‚™é–‹å§‹æŠ½çï¼</div>
            </div>
            <button class="btn btn-large" id="lotteryBtn" onclick="startLottery()" disabled>ğŸ² é–‹å§‹æŠ½ç</button>
            <button class="btn btn-large btn-secondary" onclick="resetLottery()">ğŸ”„ é‡ç½®</button>
        </div>

        <div class="winners-history" id="winnersHistory" style="display: none;">
            <h3>ğŸ† ä¸­çç´€éŒ„</h3>
            <div id="winnersList"></div>
        </div>
    </div>

    <script>
        let participants = [];
        let winners = [];
        let isLotteryRunning = false;

        function addParticipant() {
            const input = document.getElementById('participantInput');
            const name = input.value.trim();
            
            if (name === '') {
                alert('è«‹è¼¸å…¥åƒåŠ è€…å§“åï¼');
                return;
            }
            
            if (participants.includes(name)) {
                alert('æ­¤åƒåŠ è€…å·²å­˜åœ¨ï¼');
                return;
            }
            
            participants.push(name);
            input.value = '';
            updateParticipantsList();
            updateLotteryButton();
        }

        function removeParticipant(name) {
            const index = participants.indexOf(name);
            if (index > -1) {
                participants.splice(index, 1);
                updateParticipantsList();
                updateLotteryButton();
            }
        }

        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            const count = document.getElementById('participantCount');
            
            count.textContent = participants.length;
            
            if (participants.length === 0) {
                list.innerHTML = '<div class="empty-state">å°šç„¡åƒåŠ è€…ï¼Œè«‹å…ˆæ–°å¢åƒåŠ è€…</div>';
            } else {
                list.innerHTML = participants.map(name => 
                    `<div class="participant-tag">
                        ${name}
                        <button class="remove-btn" onclick="removeParticipant('${name}')">Ã—</button>
                    </div>`
                ).join('');
            }
        }

        function updateLotteryButton() {
            const btn = document.getElementById('lotteryBtn');
            btn.disabled = participants.length === 0 || isLotteryRunning;
        }

        function handleCSVFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const newParticipants = parseCSV(csv);
                    
                    if (newParticipants.length === 0) {
                        showImportStatus('CSVæª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„åƒåŠ è€…åå–®', 'error');
                        return;
                    }
                    
                    // éæ¿¾é‡è¤‡çš„åƒåŠ è€…
                    const existingNames = new Set(participants);
                    const uniqueNewParticipants = newParticipants.filter(name => !existingNames.has(name) && name.trim() !== '');
                    
                    if (uniqueNewParticipants.length === 0) {
                        showImportStatus('CSVæª”æ¡ˆä¸­çš„åƒåŠ è€…éƒ½å·²ç¶“å­˜åœ¨', 'error');
                        return;
                    }
                    
                    // æ·»åŠ æ–°åƒåŠ è€…
                    participants.push(...uniqueNewParticipants);
                    updateParticipantsList();
                    updateLotteryButton();
                    
                    showImportStatus(`æˆåŠŸåŒ¯å…¥ ${uniqueNewParticipants.length} ä½åƒåŠ è€…ï¼`, 'success');
                    
                } catch (error) {
                    console.error('CSVè§£æéŒ¯èª¤:', error);
                    showImportStatus('CSVæª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            input.value = ''; // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼Œå…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length === 0) return [];
            
            let participants = [];
            
            // æª¢æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ç‚ºæ¨™é¡Œ
            const firstLine = lines[0];
            const hasHeader = firstLine.includes('å§“å') || firstLine.includes('åå­—') || firstLine.includes('name') || firstLine.includes('Name');
            
            if (hasHeader) {
                // æœ‰æ¨™é¡Œçš„æƒ…æ³ - å°‹æ‰¾å§“åæ¬„ä½
                const headers = firstLine.split(',').map(h => h.trim().replace(/"/g, ''));
                const nameColumnIndex = headers.findIndex(header => 
                    header.includes('å§“å') || header.includes('åå­—') || 
                    header.toLowerCase().includes('name')
                );
                
                if (nameColumnIndex !== -1) {
                    // æ‰¾åˆ°å§“åæ¬„ä½ï¼Œè§£ææ•¸æ“šè¡Œ
                    for (let i = 1; i < lines.length; i++) {
                        const columns = lines[i].split(',').map(col => col.trim().replace(/"/g, ''));
                        if (columns[nameColumnIndex] && columns[nameColumnIndex].trim()) {
                            participants.push(columns[nameColumnIndex].trim());
                        }
                    }
                } else {
                    // æœ‰æ¨™é¡Œä½†æ‰¾ä¸åˆ°å§“åæ¬„ä½ï¼Œç•¶ä½œæ¯è¡Œä¸€å€‹å§“åè™•ç†ï¼ˆè·³éç¬¬ä¸€è¡Œï¼‰
                    participants = lines.slice(1)
                        .map(line => line.split(',')[0].trim().replace(/"/g, ''))
                        .filter(name => name);
                }
            } else {
                // æ²’æœ‰æ¨™é¡Œ - æ¯è¡Œç¬¬ä¸€å€‹æ¬„ä½ç•¶ä½œå§“å
                participants = lines
                    .map(line => line.split(',')[0].trim().replace(/"/g, ''))
                    .filter(name => name);
            }
            
            // å»é™¤é‡è¤‡ä¸¦éæ¿¾ç©ºå€¼
            return [...new Set(participants)].filter(name => name && name.length <= 20);
        }

        function showImportStatus(message, type) {
            // ç§»é™¤ä¹‹å‰çš„ç‹€æ…‹è¨Šæ¯
            const existingStatus = document.querySelector('.import-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `import-status import-${type}`;
            statusDiv.textContent = message;
            
            const inputSection = document.querySelector('.input-section');
            inputSection.appendChild(statusDiv);
            
            // 3ç§’å¾Œè‡ªå‹•ç§»é™¤ç‹€æ…‹è¨Šæ¯
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 3000);
        }

        function downloadSampleCSV() {
            const sampleData = `å§“å,éƒ¨é–€,è·ä½
ç‹å°æ˜,æ¥­å‹™éƒ¨,ç¶“ç†
æå°è¯,è¡Œæ”¿éƒ¨,å°ˆå“¡  
å¼µå°ç¾,ç ”ç™¼éƒ¨,å·¥ç¨‹å¸«
é™³å¤§å¼·,è²¡å‹™éƒ¨,æœƒè¨ˆ
æ—å°é›…,è¡ŒéŠ·éƒ¨,ä¼åŠƒ
é»ƒå¿—æ˜,è³‡è¨Šéƒ¨,ç¨‹å¼å¸«
å³ç¾ç²,äººè³‡éƒ¨,å°ˆå“¡
åŠ‰å»ºåœ‹,ç¸½å‹™éƒ¨,ä¸»ä»»`;

            const blob = new Blob(['\ufeff' + sampleData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'æŠ½çåƒåŠ è€…ç¯„ä¾‹.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showImportStatus('ç¯„ä¾‹ CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼', 'success');
        }

        function clearAll() {
            if (participants.length === 0) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰åƒåŠ è€…å—ï¼Ÿ')) {
                participants = [];
                updateParticipantsList();
                updateLotteryButton();
            }
        }

        function startLottery() {
            if (participants.length === 0 || isLotteryRunning) return;
            
            isLotteryRunning = true;
            const winnerDisplay = document.getElementById('winnerDisplay');
            const lotteryBtn = document.getElementById('lotteryBtn');
            
            winnerDisplay.classList.add('spinning');
            winnerDisplay.classList.remove('winner-announced');
            lotteryBtn.disabled = true;
            
            // æŠ½çå‹•ç•«æ•ˆæœ
            let spinCount = 0;
            const maxSpins = 20 + Math.floor(Math.random() * 20); // 20-40æ¬¡éš¨æ©Ÿåˆ‡æ›
            
            const spinInterval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * participants.length);
                const randomName = participants[randomIndex];
                winnerDisplay.querySelector('.winner-text').textContent = randomName;
                
                spinCount++;
                
                if (spinCount >= maxSpins) {
                    clearInterval(spinInterval);
                    announceWinner();
                }
            }, 100); // æ¯100msåˆ‡æ›ä¸€æ¬¡
        }

        function announceWinner() {
            const winnerDisplay = document.getElementById('winnerDisplay');
            const winnerIndex = Math.floor(Math.random() * participants.length);
            const winner = participants[winnerIndex];
            
            // ç§»é™¤ç²çè€…å¾åƒèˆ‡è€…åˆ—è¡¨
            participants.splice(winnerIndex, 1);
            
            // æ·»åŠ åˆ°ç²çç´€éŒ„
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-TW', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            winners.push({
                name: winner,
                time: timeString,
                round: winners.length + 1
            });
            
            // æ›´æ–°é¡¯ç¤º
            winnerDisplay.classList.remove('spinning');
            winnerDisplay.classList.add('winner-announced');
            winnerDisplay.querySelector('.winner-text').textContent = `ğŸ‰ ${winner} ğŸ‰`;
            
            // æ’­æ”¾æ…¶ç¥å‹•ç•«
            createConfetti(winnerDisplay);
            
            // æ›´æ–°åˆ—è¡¨å’ŒæŒ‰éˆ•
            updateParticipantsList();
            updateWinnersList();
            updateLotteryButton();
            
            isLotteryRunning = false;
            
            // é¡¯ç¤ºç²çç´€éŒ„å€åŸŸ
            document.getElementById('winnersHistory').style.display = 'block';
        }

        function createConfetti(container) {
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = ['#ff6b6b', '#ffd700', '#4ecdc4', '#45b7d1', '#96ceb4'][Math.floor(Math.random() * 5)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    
                    container.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 3000);
                }, i * 50);
            }
        }

        function updateWinnersList() {
            const list = document.getElementById('winnersList');
            
            if (winners.length === 0) {
                list.innerHTML = '<div class="empty-state">å°šç„¡ä¸­çç´€éŒ„</div>';
            } else {
                list.innerHTML = winners.map(winner => 
                    `<div class="winner-item">
                        ç¬¬${winner.round}è¼ªï¼š<strong>${winner.name}</strong> - ${winner.time}
                    </div>`
                ).reverse().join(''); // æœ€æ–°çš„é¡¯ç¤ºåœ¨ä¸Šé¢
            }
        }

        function resetLottery() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æŠ½çå—ï¼Ÿé€™å°‡æ¸…ç©ºæ‰€æœ‰åƒåŠ è€…å’Œä¸­çç´€éŒ„ã€‚')) {
                participants = [];
                winners = [];
                isLotteryRunning = false;
                
                document.getElementById('winnerDisplay').className = 'winner-display';
                document.getElementById('winnerDisplay').querySelector('.winner-text').textContent = 'æº–å‚™é–‹å§‹æŠ½çï¼';
                document.getElementById('winnersHistory').style.display = 'none';
                
                updateParticipantsList();
                updateWinnersList();
                updateLotteryButton();
            }
        }

        // å…è¨±æŒ‰ Enter éµæ–°å¢åƒåŠ è€…
        document.getElementById('participantInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addParticipant();
            }
        });

        // åˆå§‹åŒ–
        updateParticipantsList();
        updateLotteryButton();
    </script>
</body>
</html>
